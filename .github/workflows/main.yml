name: Deploy

on:
    push:
        branches:
            - main
jobs:
    deploy:
        name: Run deploy script
        runs-on: self-hosted
        environment: main

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Make deploy script executable
              run: chmod +x scripts/deploy.sh

            - name: Run deploy script
              env:
                  OLLAMA_MODEL: ${{ vars.OLLAMA_MODEL }}
                  CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
                  INDEX_PATH: ${{ vars.INDEX_PATH }}
                  INDEX_NAME: ${{ vars.INDEX_NAME }}
                  DATAFRAME_NAME: ${{ vars.DATAFRAME_NAME }}
                  DATA_PATH: ${{ vars.DATA_PATH }}
                  CSV_PATH: ${{ vars.CSV_PATH }}
                  MONGO_INITDB_ROOT_USERNAME: ${{ secrets.MONGO_INITDB_ROOT_USERNAME }}
                  MONGO_INITDB_ROOT_PASSWORD: ${{ secrets.MONGO_INITDB_ROOT_PASSWORD }}
                  MONGO_INITDB_DATABASE: ${{ secrets.MONGO_INITDB_DATABASE }}
                  MONGO_DATA: ${{ vars.MONGO_DATA }}
              run: ./scripts/deploy.sh
